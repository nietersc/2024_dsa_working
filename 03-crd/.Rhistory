# Summary
summary(crd_mod)
Anova(crd_mod, type = 3)
View(crd_dfw)
# Model fitting
crd_mod <- lm(yield_kgha ~ nrate_kgha * krate_kgha,
data = crd_dfw)
# Summary
summary(crd_mod)
Anova(crd_mod, type = 3)
# Chunk 1: setup
#| warning: false
#| message: false
library(tidyverse)
library(car) # for Anova function
library(broom) # for model residuals extraction
library(emmeans) # for model mean extraction
library(multcomp) # for pairwise comparison letter display
library(multcompView)
library(ggsci)
# Chunk 2: data import
crd_df <- read.csv("data/wheat_nk_bamyan.csv")
# Chunk 3: summary
summary(crd_df)
# Chunk 4: glimpse
glimpse(crd_df)
# Chunk 5
crd_dfw <- crd_df |>
mutate_at(
vars(krate_kgha,nrate_kgha,rep), as.factor)|>
mutate(
trt_name = paste0(krate_kgha,"+",nrate_kgha)
)
# Chunk 6
#| echo: false
#| fig-width: 7
#| fig-height: 3
crd_dfw|>
ggplot(aes(x = nrate_kgha, y = yield_kgha,
color = nrate_kgha))+
geom_boxplot()+
geom_jitter(alpha = 0.4)+
theme(
legend.position = "none"
)+
scale_color_npg()
# Chunk 7
#| echo: false
#| #| fig-width: 2
#| fig-height: 3
ggplot(crd_dfw, aes(x = krate_kgha,
y = yield_kgha,
color = krate_kgha)) +
geom_boxplot() +
geom_jitter(alpha = 0.4) +
theme(legend.position = "none")+
scale_color_npg()
# Chunk 8
#| echo: false
#| fig-width: 8
#| fig-height: 3
crd_dfw |>
ggplot(aes(x = nrate_kgha, y = yield_kgha,
color = nrate_kgha,))+
geom_boxplot()+
geom_jitter(alpha = 0.4)+
facet_grid(~krate_kgha)+
theme(legend.position = "none")+
scale_color_npg()
crd_dfw |>
ggplot(aes(x = krate_kgha, y = yield_kgha,
color = nrate_kgha,))+
geom_boxplot()+
geom_jitter(alpha = 0.4)+
facet_grid(~nrate_kgha)+
theme(legend.position = "none")+
scale_color_npg()
# Chunk 9
# Changing to sum-to-zero contrast
options(contrasts = c("contr.sum", "contr.poly"))
# attach dataframe to include in model
attach(crd_dfw)
# Model fitting
crd_mod <- lm(yield_kgha ~ nrate_kgha*krate_kgha,
data = crd_dfw)
# Summary
summary(crd_mod)
# Chunk 10
#| echo: true
Anova(crd_mod, type = 3)
# Chunk 11
#| echo: true
crd_modn <- lm(yield_kgha ~ nrate_kgha)
crd_modk <- lm(yield_kgha ~ krate_kgha)
Anova(crd_modn, type = 3)
Anova(crd_modk, type = 3)
# Chunk 12
#| echo: true
crd_residn <- broom::augment(crd_modn) |>
mutate(
.stud_resid = rstudent(crd_modn)
)
crd_residk <- broom::augment(crd_modk) |>
mutate(
.stud_resid = rstudent(crd_modk)
)
# Chunk 13
#| echo: true
crd_meansn <- emmeans::emmeans(crd_modn,
~nrate_kgha)
crd_meansk <- emmeans::emmeans(crd_modk,
~krate_kgha)
# Chunk 14
#| echo: true
crd_cldn <- cld(crd_meansn,
reversed=T,
adjust="none",
Letters=letters)
crd_cldk <- cld(crd_meansk,
reversed=T,
adjust="none",
Letters=letters)
combined_cldk <- crd_cldn |>
full_join(crd_cldk)
# Chunk 15
crd_cld_selected <- combined_cldk|>
as.data.frame() |>
mutate(
letter = trimws(.group),
trt_name = paste0(krate_kgha,"+",nrate_kgha)
) |>
pivot_longer(
c(1,8),
names_to = "element",
values_to = "rate_kgha"
) |>
mutate(
element = case_when(
element == "nrate_kgha" ~ "nitrogen",
element == "krate_kgha" ~ "potassium"
)
)|>
drop_na()
crd_dfw <- crd_dfw |>
pivot_longer(
c(3,4),
names_to = "element",
values_to = "rate_kgha"
)|>
mutate(
element = case_when(
element == "nrate_kgha" ~ "nitrogen",
element == "krate_kgha" ~ "potassium"
)
)
ggplot()+
geom_boxplot(data = crd_dfw,
aes(x = rate_kgha, y = yield_kgha,
fill = rate_kgha), color = "black",
alpha = 0.6, lwd = 0.6)+
geom_jitter(data = crd_dfw,
aes(x = rate_kgha, y = yield_kgha,
fill = rate_kgha), alpha = 0.5,
width = 0.4, shape = 21)+
geom_label(data = crd_cld_selected,
aes(x = rate_kgha, y = emmean,
label = letter,vjust = -0.15),
label.size = NA, size = 6,
alpha = 0)+
scale_y_continuous(limits = c(600,7500))+
facet_wrap(~element, scales = "free",
nrow = 1)+
theme_bw()+
theme(
panel.spacing.x = unit(4, "lines"),
panel.background = element_rect(fill = 'lightgrey'),
strip.background = element_rect(fill = "grey27"),
strip.text = element_text(size = 14,
face = "bold",
color = "white"),
axis.title.y = element_text(
size = 16,
face = "bold",
margin = margin(r = 25)),
axis.title.x = element_text(
size = 16,
face = "bold",
margin = margin(t = 25)),
axis.text.y = element_text(
margin = margin(t = 5),
size = 10,
face = "bold"),
axis.text.x = element_text(
margin = margin(t = 5),
size = 10,
face = "bold"),
legend.position = "none")+
ylab("Yield (kg/ha)")+
xlab("Application rate (kg/ha)")+
scale_fill_npg()+
scale_color_npg()
Anova(crd_mod, type = 3)
car::Anova(crd_mod, type = 3)
# Model fitting
crd_mod <- lm(yield_kgha ~ nrate_kgha*krate_kgha)
# Summary
summary(crd_mod)
car::Anova(crd_mod, type = 3)
crd_df <- read.csv("../data/wheat_nk_bamyan.csv")
crd_df <- read.csv("data/wheat_nk_bamyan.csv")
#| warning: false
#| message: false
library(tidyverse)
library(car) # for Anova function
library(broom) # for model residuals extraction
library(emmeans) # for model mean extraction
library(multcomp) # for pairwise comparison letter display
library(multcompView)
library(ggsci)
crd_dfw <- crd_df |>
mutate_at(
vars(krate_kgha,nrate_kgha,rep), as.factor)|>
mutate(
trt_name = paste0(krate_kgha,"+",nrate_kgha)
)
#| echo: false
#| fig-width: 7
#| fig-height: 3
crd_dfw|>
ggplot(aes(x = nrate_kgha, y = yield_kgha,
color = nrate_kgha))+
geom_boxplot()+
geom_jitter(alpha = 0.4)+
theme(
legend.position = "none"
)+
scale_color_npg()
#| echo: false
#| #| fig-width: 2
#| fig-height: 3
ggplot(crd_dfw, aes(x = krate_kgha,
y = yield_kgha,
color = krate_kgha)) +
geom_boxplot() +
geom_jitter(alpha = 0.4) +
theme(legend.position = "none")+
scale_color_npg()
#| echo: false
#| fig-width: 8
#| fig-height: 3
crd_dfw |>
ggplot(aes(x = nrate_kgha, y = yield_kgha,
color = nrate_kgha,))+
geom_boxplot()+
geom_jitter(alpha = 0.4)+
facet_grid(~krate_kgha)+
theme(legend.position = "none")+
scale_color_npg()
# Changing to sum-to-zero contrast
options(contrasts = c("contr.sum", "contr.poly"))
# attach dataframe to include in model
attach(crd_dfw)
# Model fitting
crd_mod <- lm(yield_kgha ~ nrate_kgha*krate_kgha)
# Summary
summary(crd_mod)
car::Anova(crd_mod, type = 3)
# Model fitting
crd_mod <- lm(yield_kgha ~ nrate_kgha+krate_kgha)
# Summary
summary(crd_mod)
car::Anova(crd_mod, type = 3)
crd_meansk <- emmeans::emmeans(crd_modk,
~krate_kgha+nrate_kgha)
crd_meansk <- emmeans::emmeans(crd_mod,
~krate_kgha+nrate_kgha)
crd_means <- emmeans::emmeans(crd_mod,
~krate_kgha+nrate_kgha)
View(crd_means)
crd_cld <- cld(crd_means,
reversed=T,
adjust="none",
Letters=letters)
View(crd_cld)
Anova(crd_mod, type = 3)
Anova(crd_mod, type = 3)
Anova(crd_modn, type = 3)
crd_modn <- lm(yield_kgha ~ nrate_kgha)
crd_modk <- lm(yield_kgha ~ krate_kgha)
Anova(crd_modn, type = 3)
Anova(crd_modk, type = 3)
Anova(crd_mod, type = 3)
crd_means <- emmeans::emmeans(crd_mod,
~krate_kgha+nrate_kgha)
crd_cld <- cld(crd_means,
reversed=T,
adjust="none",
Letters=letters)
#calc studentized residuals N
crd_residn <- broom::augment(crd_modn) |>
mutate(
.stud_resid = rstudent(crd_modn)
)
#calc studentized residuals K
crd_residk <- broom::augment(crd_modk) |>
mutate(
.stud_resid = rstudent(crd_modk)
)
View(crd_residk)
combined_resid <- crd_residn |>
full_join(crd_residk)
View(combined_resid)
#model for N rate
crd_modn <- lm(yield_kgha ~ nrate_kgha)
#ANOVA for N rate
Anova(crd_modn, type = 3)
#model for K rate
crd_modk <- lm(yield_kgha ~ krate_kgha)
#ANOVA for K rate
Anova(crd_modk, type = 3)
#combine residual tables
combined_resid <- crd_residn |>
full_join(crd_residk)|>
pivot_longer(
c(2,10),
names_to = "element",
values_to = "rate_kgha"
)
#combine residual tables
combined_resid <- crd_residn |>
full_join(crd_residk)|>
pivot_longer(
c(2,10),
names_to = "element",
values_to = "rate_kgha"
) |>
drop_na()
combined_resid |>
ggplot(aes(x = .fitted, y = .stud_resid))+
geom_hline(yintercept = c(-3,0,3),
color = "red",
linewidth = 1,
alpha = 0.5)+
geom_smooth(color = "purple4", fill = "purple")+
geom_point(shape = 21,
fill = "purple",
size = 3,
alpha = 0.7)+
fact_wrap(~element, scales = "free")
combined_resid |>
ggplot(aes(x = .fitted, y = .stud_resid))+
geom_hline(yintercept = c(-3,0,3),
color = "red",
linewidth = 1,
alpha = 0.5)+
geom_smooth(color = "purple4", fill = "purple")+
geom_point(shape = 21,
fill = "purple",
size = 3,
alpha = 0.7)+
facet_wrap(~element, scales = "free")
ggplot(combined_resid, aes(x=.fitted, y=.stud_resid))+
geom_hline(yintercept = 0, color="red")+
geom_point(shape = 21,
fill = "purple",
size = 3,
alpha = .7)+
geom_smooth()+
geom_hline(yintercept = c(-3,3), color = "red")+
theme_bw()
combined_resid |>
ggplot(aes(x = .fitted, y = .stud_resid))+
geom_hline(yintercept = c(-3,0,3),
color = "red",
linewidth = 1,
alpha = 0.5)+
geom_smooth()+
geom_point(shape = 21,
fill = "purple",
size = 3,
alpha = 0.7)+
facet_wrap(~element, scales = "free")
combined_resid |>
ggplot(aes(x = .fitted, y = .stud_resid))+
geom_smooth()+
geom_point(shape = 21,
fill = "purple",
size = 3,
alpha = 0.7)+
facet_wrap(~element, scales = "free")
combined_resid |>
ggplot(aes(x = .fitted, y = .stud_resid))+
geom_smooth()+
geom_point(shape = 21,
fill = "purple",
size = 3,
alpha = 0.7)+
facet_wrap(~element)
ggplot(combined_resid, aes(x=.fitted, y=.stud_resid))+
geom_hline(yintercept = 0, color="red")+
geom_point(shape = 21,
fill = "purple",
size = 3,
alpha = .7)+
geom_smooth()+
geom_hline(yintercept = c(-3,3), color = "red")+
theme_bw()
ggplot(combined_resid, aes(x=.fitted, y=.stud_resid))+
geom_hline(yintercept = 0, color="red")+
geom_point(shape = 21,
fill = "purple",
size = 3,
alpha = .7)+
geom_smooth()+
geom_hline(yintercept = c(-3,3), color = "red")+
theme_bw()+
facet_wrap(~element)
ggplot(combined_resid, aes(x=.fitted, y=.stud_resid))+
geom_hline(yintercept = 0, color="red")+
geom_point(shape = 21,
fill = "purple",
size = 3,
alpha = .7)+
geom_smooth()+
geom_hline(yintercept = c(-3,3), color = "red")+
theme_bw()+
facet_wrap(~element, scales = "free")
combined_resid |>
ggplot(aes(sample = .stud_resid))+
stat_qq()+
stat_qq_line()+
facet_wrap(~element, scales = "free")
crd_resid |>
ggplot(aes(x = .stud_resid))+
geom_density(fill = "purple",
alpha = 0.2)+
scale_x_continuous(
breaks = c(-3,0,3),
limits = c(-3,3)
)+
theme_minimal()+
facet_wrap(~element, scales = "free")
combined_resid |>
ggplot(aes(x = .stud_resid))+
geom_density(fill = "purple",
alpha = 0.2)+
scale_x_continuous(
breaks = c(-3,0,3),
limits = c(-3,3)
)+
theme_minimal()+
facet_wrap(~element, scales = "free")
ggplot(combined_resid, aes(x=.fitted, y=.stud_resid))+
geom_hline(yintercept = 0, color="red")+
geom_point(shape = 21,
fill = "purple",
size = 3,
alpha = .7)+
geom_smooth()+
geom_hline(yintercept = c(-3,3), color = "red")+
theme_bw()+
facet_wrap(~element, scales = "free")
#Final plot
ggplot()+
geom_boxplot(data = crd_dfw,
aes(x = rate_kgha, y = yield_kgha,
fill = rate_kgha), color = "black",
alpha = 0.6, lwd = 0.6)+
geom_jitter(data = crd_dfw,
aes(x = rate_kgha, y = yield_kgha,
fill = rate_kgha), alpha = 0.5,
width = 0.4, shape = 21)+
geom_label(data = crd_cld_selected,
aes(x = rate_kgha, y = emmean,
label = letter,vjust = -0.15),
label.size = NA, size = 6,
alpha = 0)+
scale_y_continuous(limits = c(600,7500))+
theme_bw()+
theme(
panel.spacing.x = unit(4, "lines"),
panel.background = element_rect(
fill = 'lightgrey'),
strip.background = element_rect(
fill = "grey27"),
strip.text = element_text(
size = 14,
face = "bold",
color = "white"),
axis.title.y = element_text(
size = 16,
face = "bold",
margin = margin(r = 25)),
axis.title.x = element_text(
size = 16,
face = "bold",
margin = margin(t = 25)),
axis.text.y = element_text(
margin = margin(t = 5),
size = 10,
face = "bold"),
axis.text.x = element_text(
margin = margin(t = 5),
size = 10,
face = "bold"),
legend.position = "none")+
ylab("Yield (kg/ha)")+
xlab("Application rate (kg/ha)")+
scale_fill_npg()+
scale_color_npg()+
facet_wrap(~element, scales = "free",
nrow = 2)
